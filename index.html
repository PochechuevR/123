<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToDo Web3</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
    }
    h1 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      background: #2a2a2a;
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #00A8FF;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .btn:hover {
      background: #0088CC;
    }
    .task, .subtask {
      background: #2A2A2A;
      padding: 10px;
      margin: 5px 0;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task.completed, .subtask.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .task-content, .subtask-content {
      flex-grow: 1;
      overflow: hidden;
      margin-right: 10px;
    }
    .task-title, .subtask-title {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      margin-bottom: 4px;
    }
    .description {
      font-size: 12px;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .time-info {
      font-size: 10px;
      color: #888;
      margin-top: 3px;
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
    }
    .complete-btn { color: #00FF90; }
    .overdue { color: #ff6b6b !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Список дел</h1>
    <input type="text" id="taskInput" placeholder="Новая задача..." maxlength="50" />
    <button class="btn" onclick="addTask()">Добавить</button>
    <div id="taskList"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const userId = tg.initDataUnsafe.user?.id || 'anonymous';

    const firebaseConfig = {
      apiKey: "AIzaSyANHM115TxFfva5d-oMDKAtPmBF_59OgTA",
      authDomain: "financeai-e9f18.firebaseapp.com",
      databaseURL: "https://todoapp-e0f58-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "financeai-e9f18",
      storageBucket: "financeai-e9f18.appspot.com",
      messagingSenderId: "71690881541",
      appId: "1:71690881541:web:c68e6ecf51082dfbedaa6c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("users/" + userId + "/tasks");

    function addTask() {
      const taskText = document.getElementById("taskInput").value.trim();
      if (!taskText) return;

      db.push({
        text: taskText,
        completed: false,
        description: "",
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        deadline: null,
        subtasks: {}
      });
      document.getElementById("taskInput").value = "";
    }

    function formatDate(timestamp) {
      if (!timestamp) return "Не указано";
      const date = new Date(timestamp);
      return date.toLocaleString('ru-RU', {
        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function isOverdue(deadline) {
      return deadline && new Date(deadline) < new Date();
    }

    function renderTasks(snapshot) {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";
      const tasks = [];
      snapshot.forEach(child => tasks.push({ key: child.key, ...child.val() }));
      tasks.sort((a, b) => a.completed - b.completed || (b.createdAt || 0) - (a.createdAt || 0));

      tasks.forEach(task => {
        const taskDiv = document.createElement("div");
        taskDiv.className = "task" + (task.completed ? " completed" : "");
        const deadlineClass = !task.completed && isOverdue(task.deadline) ? "overdue" : "";

        taskDiv.innerHTML = `
          <div class="task-content">
            <div class="task-title" title="${task.text}">${task.text.length > 22 ? task.text.slice(0, 22) + '...' : task.text}</div>
            ${task.description ? `<div class="description" title="${task.description}">${task.description}</div>` : ""}
            <div class="time-info" id="time-info-${task.key}" style="display:none;">
              Создано: ${formatDate(task.createdAt)}<br>
              ${task.deadline ? `Дедлайн: <span class="${deadlineClass}">${formatDate(task.deadline)}</span>` : "Дедлайн не установлен"}
            </div>
          </div>
          <div class="actions">
            <button class="complete-btn" onclick="toggleComplete('${task.key}', ${!task.completed})">✔️</button>
            <button onclick="showTimeInfo('${task.key}')">⏰</button>
            <button onclick="editTask('${task.key}', '${task.text.replace(/'/g, "\\'")}', '${task.description?.replace(/'/g, "\\'") || ''}', ${task.deadline || 'null'})">✏️</button>
            <button onclick="deleteTask('${task.key}')">❌</button>
            <button onclick="addSubtask('${task.key}')">➕</button>
          </div>`;

        taskList.appendChild(taskDiv);

        if (task.subtasks) {
          Object.entries(task.subtasks).forEach(([subKey, sub]) => {
            const subDiv = document.createElement("div");
            subDiv.className = "subtask" + (sub.completed ? " completed" : "");
            const shortText = sub.text.length > 30 ? sub.text.slice(0, 30) + '...' : sub.text;

            subDiv.innerHTML = `
              <div class="subtask-content">
                <div class="subtask-title" title="${sub.text}">${shortText}</div>
              </div>
              <div class="actions">
                <button class="complete-btn" onclick="toggleSubtaskComplete('${task.key}', '${subKey}', ${!sub.completed})">✔️</button>
                <button onclick="editSubtask('${task.key}', '${subKey}', '${sub.text.replace(/'/g, "\\'")}')">✏️</button>
                <button onclick="deleteSubtask('${task.key}', '${subKey}')">❌</button>
              </div>
            `;
            taskList.appendChild(subDiv);
          });
        }
      });
    }

    function toggleComplete(key, completed) {
      db.child(key).update({ completed });
    }

    function deleteTask(key) {
      if (confirm("Удалить задачу?")) db.child(key).remove();
    }

    function showTimeInfo(key) {
      const info = document.getElementById(`time-info-${key}`);
      info.style.display = info.style.display === 'none' ? 'block' : 'none';
    }

    function editTask(key, currentText, currentDesc, currentDeadline) {
      const newText = prompt("Название:", currentText);
      if (newText === null) return;
      const newDesc = prompt("Описание:", currentDesc);
      if (newDesc === null) return;
      let newDeadline = currentDeadline;
      const input = prompt("Дедлайн (ДД.ММ.ГГГГ ЧЧ:ММ):", currentDeadline ? formatDate(currentDeadline) : "");
      if (input !== null) {
        if (!input.trim()) newDeadline = null;
        else {
          const [d, m, y, h = '23', min = '59'] = input.match(/\d+/g) || [];
          const date = new Date(y, m - 1, d, h, min);
          if (!isNaN(date)) newDeadline = date.getTime();
          else return alert("Неверный формат даты!");
        }
      }
      db.child(key).update({ text: newText.trim(), description: newDesc.trim(), deadline: newDeadline });
    }

    function addSubtask(taskKey) {
      const subText = prompt("Текст подзадачи:");
      if (!subText) return;
      db.child(taskKey).child("subtasks").push({ text: subText.trim(), completed: false });
    }

    function toggleSubtaskComplete(taskKey, subKey, completed) {
      db.child(taskKey).child("subtasks").child(subKey).update({ completed });
    }

    function editSubtask(taskKey, subKey, currentText) {
      const newText = prompt("Редактировать подзадачу:", currentText);
      if (newText) db.child(taskKey).child("subtasks").child(subKey).update({ text: newText.trim() });
    }

    function deleteSubtask(taskKey, subKey) {
      if (confirm("Удалить подзадачу?")) db.child(taskKey).child("subtasks").child(subKey).remove();
    }

    db.on("value", renderTasks);
    tg.BackButton.onClick(() => tg.close());
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Задачи</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="taskList"></div>

  <script>
    function formatDate(timestamp) {
      if (!timestamp) return "";
      const date = new Date(timestamp);
      return date.toLocaleString("ru-RU");
    }

    function isOverdue(deadline) {
      return deadline && new Date(deadline) < new Date();
    }

    function renderTasks(snapshot) {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      const tasks = [];
      snapshot.forEach(childSnapshot => {
        const task = childSnapshot.val();
        task.key = childSnapshot.key;
        tasks.push(task);
      });

      tasks.sort((a, b) => {
        if (a.completed === b.completed) {
          if (!a.completed && !b.completed) {
            if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline);
            if (a.deadline) return -1;
            if (b.deadline) return 1;
          }
          return (b.createdAt || 0) - (a.createdAt || 0);
        }
        return a.completed ? 1 : -1;
      });

      for (const task of tasks) {
        const taskDiv = document.createElement("div");
        taskDiv.className = "task" + (task.completed ? " completed" : "");
        const deadlineClass = !task.completed && isOverdue(task.deadline) ? "overdue" : "";
        taskDiv.innerHTML = `
          <div class="task-content">
            <div class="task-title" title="${task.text}">${task.text.length > 22 ? task.text.substring(0, 22) + '...' : task.text}</div>
            ${task.description ? `<div class="description" title="${task.description}">${task.description}</div>` : ""}
            <div class="time-info" id="time-info-${task.key}" style="display: none;">
              Создано: ${formatDate(task.createdAt)}<br>
              ${task.deadline ? `Дедлайн: <span class="${deadlineClass}">${formatDate(task.deadline)}</span>` : "Дедлайн не установлен"}
            </div>
          </div>
          <div class="actions">
            <button class="complete-btn" onclick="toggleComplete('${task.key}', ${!task.completed})">✔️</button>
            <button onclick="showTimeInfo('${task.key}')">⏰</button>
            <button onclick="editTask('${task.key}', '${task.text.replace(/'/g, "\\'")}', '${task.description ? task.description.replace(/'/g, "\\'") : ''}', ${task.deadline || 'null'})">✏️</button>
            <button onclick="deleteTask('${task.key}')">❌</button>
            <button onclick="addSubtask('${task.key}')">➕</button>
          </div>
        `;

        if (task.subtasks) {
          const subtaskContainer = document.createElement("div");
          subtaskContainer.className = "subtask-list";
          Object.entries(task.subtasks).forEach(([subKey, subtask]) => {
            const subtaskDiv = document.createElement("div");
            subtaskDiv.className = "subtask";
            subtaskDiv.innerHTML = `
              <label style="flex-grow:1;">
                <input type="checkbox" ${subtask.completed ? "checked" : ""} 
                  onchange="toggleSubtaskComplete('${task.key}', '${subKey}', ${!subtask.completed})">
                ${subtask.text}
              </label>
              <div class="subtask-buttons">
                <button onclick="editSubtask('${task.key}', '${subKey}', '${subtask.text.replace(/'/g, "\\'")}')">✏️</button>
                <button onclick="deleteSubtask('${task.key}', '${subKey}')">❌</button>
              </div>
            `;
            subtaskContainer.appendChild(subtaskDiv);
          });
          taskDiv.querySelector(".task-content").appendChild(subtaskContainer);
        }

        taskList.appendChild(taskDiv);
      }
    }

    // Заглушки — предполагается, что они у тебя уже есть в проекте
    function toggleComplete(taskKey, isComplete) {}
    function showTimeInfo(taskKey) {}
    function editTask(key, text, desc, deadline) {}
    function deleteTask(key) {}
    function addSubtask(key) {}
    function toggleSubtaskComplete(taskKey, subKey, isComplete) {}
    function editSubtask(taskKey, subKey, text) {}
    function deleteSubtask(taskKey, subKey) {}
  </script>
</body>
</html>

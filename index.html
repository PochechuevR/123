<!DOCTYPE html>
<html>
<head>
  <title>Web3 To-Do List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      max-width: 600px;
      margin: 0 auto;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
      text-align: center;
    }
    .task-input {
      display: flex;
      margin-bottom: 20px;
    }
    #newTask {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .task {
      background: white;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task.completed {
      opacity: 0.7;
      text-decoration: line-through;
    }
    .task-actions button {
      margin-left: 5px;
      padding: 5px 10px;
      font-size: 12px;
    }
    #wallet-section {
      text-align: center;
      margin-bottom: 20px;
    }
    #walletAddress {
      font-family: monospace;
      word-break: break-all;
      margin-top: 10px;
      color: #555;
    }
    .hidden {
      display: none;
    }
    #loading {
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>Web3 To-Do List</h1>
  
  <div id="wallet-section">
    <button id="connectWallet">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    <div id="walletAddress"></div>
  </div>
  
  <div id="task-section" class="hidden">
    <div class="task-input">
      <input type="text" id="newTask" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É...">
      <button id="addTask">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
    <div id="tasks"></div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const CONTRACT_ADDRESS = '0xYOUR_CONTRACT_ADDRESS';
    const CONTRACT_ABI = [
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "user",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "taskId",
            "type": "uint256"
          },
          {
            "indexed": false,
            "internalType": "string",
            "name": "content",
            "type": "string"
          }
        ],
        "name": "TaskAdded",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "user",
            "type": "address"
          },
          {
            "indexed": false,
            "internalType": "uint256",
            "name": "taskId",
            "type": "uint256"
          }
        ],
        "name": "TaskCompleted",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "_content",
            "type": "string"
          }
        ],
        "name": "addTask",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "_taskId",
            "type": "uint256"
          }
        ],
        "name": "completeTask",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getTasks",
        "outputs": [
          {
            "components": [
              {
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
              },
              {
                "internalType": "string",
                "name": "content",
                "type": "string"
              },
              {
                "internalType": "bool",
                "name": "completed",
                "type": "bool"
              },
              {
                "internalType": "uint256",
                "name": "createdAt",
                "type": "uint256"
              }
            ],
            "internalType": "struct Web3TodoList.Task[]",
            "name": "",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "taskCount",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];
    const RPC_URL = 'https://polygon-rpc.com';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    let web3;
    let contract;
    let walletAddress;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const connectWalletBtn = document.getElementById('connectWallet');
    const walletAddressEl = document.getElementById('walletAddress');
    const taskSection = document.getElementById('task-section');
    const addTaskBtn = document.getElementById('addTask');
    const newTaskInput = document.getElementById('newTask');
    const tasksContainer = document.getElementById('tasks');
    const loadingEl = document.getElementById('loading');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    connectWalletBtn.addEventListener('click', connectWallet);
    addTaskBtn.addEventListener('click', addTask);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ MetaMask
    if (typeof window.ethereum === 'undefined') {
      connectWalletBtn.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask';
      connectWalletBtn.disabled = true;
    }
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
    async function connectWallet() {
      try {
        connectWalletBtn.disabled = true;
        connectWalletBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        
        // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web3
        web3 = new Web3(window.ethereum);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        walletAddressEl.textContent = `–ö–æ—à–µ–ª–µ–∫: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
        taskSection.classList.remove('hidden');
        connectWalletBtn.style.display = 'none';
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
        loadTasks();
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            // –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω
            location.reload();
          } else {
            walletAddress = accounts[0];
            walletAddressEl.textContent = `–ö–æ—à–µ–ª–µ–∫: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
            loadTasks();
          }
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        connectWalletBtn.disabled = false;
        connectWalletBtn.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫';
        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + error.message);
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
    async function loadTasks() {
      try {
        loadingEl.style.display = 'block';
        tasksContainer.innerHTML = '';
        
        const tasks = await contract.methods.getTasks().call({ from: walletAddress });
        
        if (tasks.length === 0) {
          tasksContainer.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
        } else {
          tasks.forEach((task, index) => {
            const taskEl = document.createElement('div');
            taskEl.className = `task ${task.completed ? 'completed' : ''}`;
            taskEl.innerHTML = `
              <span>${task.content}</span>
              <div class="task-actions">
                ${!task.completed ? `<button onclick="completeTask(${task.id})">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>` : ''}
              </div>
            `;
            tasksContainer.appendChild(taskEl);
          });
        }
        
        loadingEl.style.display = 'none';
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
        tasksContainer.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>';
        loadingEl.style.display = 'none';
      }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function addTask() {
      const taskText = newTaskInput.value.trim();
      if (!taskText) return;
      
      try {
        addTaskBtn.disabled = true;
        addTaskBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        
        await contract.methods.addTask(taskText).send({ from: walletAddress });
        
        newTaskInput.value = '';
        loadTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message);
      } finally {
        addTaskBtn.disabled = false;
        addTaskBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
      }
    }
    
    // –û—Ç–º–µ—Ç–∫–∞ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
    window.completeTask = async function(taskId) {
      try {
        await contract.methods.completeTask(taskId).send({ from: walletAddress });
        loadTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
        alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: ' + error.message);
      }
    };
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
    if (window.ethereum && window.ethereum.selectedAddress) {
      connectWallet();
    }
  </script>
</body>
</html>
